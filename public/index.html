<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MetricsGraphics - Dados em Tempo Real</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/metrics-graphics/dist/metricsgraphics.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.1/css/all.min.css"
        integrity="sha512-5Hs3dF2AEPkpNAR7UiOHba+lRSJNeM2ECkwxUIxC1Q/FLycGTbNapWXB4tP889k5T5Ju8fs4b1P5z/iB4nMfSQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>

<body>
    <nav class="navbar navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <!-- <img src="./image/graf.png" alt="" width="30" height="24" class="d-inline-block align-text-top"> -->
                Dados do Pêndulo
            </a>
        </div>
    </nav>
    <div class="row p-3 d-flex align-items-end">
        <div class=" col-3 px-0">
            <label for="graus" style="font-weight: 600;"><i class="fa-brands fa-usb"></i> Porta Serial</label>
            <select class="form-select" aria-label="Default select example" id="port">
                <option selected>Selecione a porta</option>
                <option value="COM1">COM1</option>
                <option value="COM3">COM3</option>
                <option value="COM8">COM8</option>
                <option value="COM9">COM9</option>
            </select>
        </div>
        <div class="col">
            <input id="msg" hidden /><button id="send" class="btn btn-success"><i class="fa fa-play"
                    aria-hidden="true"></i> Iniciar</button> <button class="btn btn-danger" id="refresh"><i
                    class="fa-solid fa-arrows-rotate"></i> Reiniciar</button>
        </div>
    </div>

    <div class="row" style="background: #dedad6; padding: 20px;">
        <div class="col-9" style="background: #fff;">
            <div id="chart" class="mg-line-chart" style="width: 800px; height: 400px; margin: auto;"></div>
        </div>
        <div class="col ms-2" style="width: 200px; height: 400px; overflow-y: scroll; background: #fff;">
            <div id="output"></div>
        </div>
    </div>
    <div class="row">
        <div class="p-3 col-3">
            <label for="graus" style="font-weight: 600;">Graus</label>
            <input type="text" id="graus" class="form-control">
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>

    <script src="https://cdn.jsdelivr.net/npm/d3/dist/d3.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/metrics-graphics/dist/metricsgraphics.min.js"></script>
    <script>
        // Inicializa os dados do gráfico
        let chartData = []; // [{ date: Date, value: number }]

        // Adiciona espaço no eixo X
        let minX = new Date(); // Define o início do intervalo (exemplo: agora)
        let maxX = new Date(minX.getTime() + 60 * 1000);

        // Função para renderizar o gráfico
        function renderChart(data) {
            MG.data_graphic({
                title: "Gráfico em Tempo Real",
                description: "Atualizado em tempo real via WebSocket",
                data: data,
                full_width: true,
                height: 400,
                target: "#chart",
                x_accessor: "date",
                y_accessor: "value",
                min_x: minX, // Define o limite inferior do eixo X
                max_x: maxX, // Define o limite superior do eixo X
                min_y: -50,
                max_y: 50,
                show_tooltips: true,
                animate_on_load: true,
            });
        }

        // Inicializa o gráfico vazio
        renderChart(chartData);

        // WebSocket para receber dados
        const ws = new WebSocket("ws://localhost:3000");

        const output = document.getElementById("output");
        const send = document.getElementById("send");
        const grausInput = document.getElementById("graus")
        const refresh = document.getElementById("refresh")

        send.addEventListener("click", () => {
            // const msg = document.getElementById("msg").value;
            const port = document.getElementById("port").value
            // ws.send(msg);
            ws.send(port);
            output.innerHTML += log("Sent", port);
        });

        refresh.addEventListener("click", () => {
            chartData = []
            renderChart(chartData);
        })

        function log(event, msg) {
            return "<p>" + event + ": " + msg + "</p>";
        }

        ws.onmessage = function (e) {
            output.innerHTML += log("Received", e.data);

            const receivedData = JSON.parse(e.data);
            const timestamp = new Date(receivedData.timestamp);
            const value = parseFloat(receivedData.value);

            // Adiciona novos dados ao gráfico
            chartData.push({ date: timestamp, value: value });

            // Atualiza min_x e max_x para manter 60 segundos de intervalo
            minX = new Date(chartData[0].date.getTime() - 10 * 1000); // 10 segundos antes do primeiro ponto
            maxX = new Date(chartData[chartData.length - 1].date.getTime() + 10 * 1000); // 10 segundos depois do último ponto
            grausInput.value = value
            renderChart(chartData);
        };

        ws.onclose = function (e) {
            output.innerHTML += log("Disconnected", e.code);
        };

        ws.onerror = function (e) {
            output.innerHTML += log("Error", e.data);
        };
    </script>
</body>

</html>