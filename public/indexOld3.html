<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MetricsGraphics - Dados em Tempo Real</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/metrics-graphics/dist/metricsgraphics.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.1/css/all.min.css"
        integrity="sha512-5Hs3dF2AEPkpNAR7UiOHba+lRSJNeM2ECkwxUIxC1Q/FLycGTbNapWXB4tP889k5T5Ju8fs4b1P5z/iB4nMfSQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>

<body>
    <nav class="navbar navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <!-- <img src="./image/graf.png" alt="" width="30" height="24" class="d-inline-block align-text-top"> -->
                Dados do Pêndulo
            </a>
        </div>
    </nav>
    <div class="row p-3 d-flex align-items-end">
        <div class=" col-3 px-0">
            <label for="graus" style="font-weight: 600;"><i class="fa-brands fa-usb"></i> Porta Serial</label>
            <select class="form-select" aria-label="Default select example" id="port">
                <option selected>Selecione a porta</option>
                <option value="COM1">COM1</option>
                <option value="COM3">COM3</option>
                <option value="COM8">COM8</option>
                <option value="COM9">COM9</option>
            </select>
        </div>
        <div class="col">
            <button id="send" class="btn btn-success"><i class="fa fa-play" aria-hidden="true"></i> Iniciar</button>
            <button id="pause" class="btn btn-warning">Pausar</button>
            <button class="btn btn-danger" id="refresh"><i class="fa-solid fa-arrows-rotate"></i> Reiniciar</button>
        </div>
    </div>

    <div class="row" style="background: #dedad6; padding: 20px;">
        <div class="col-9" style="background: #fff;">
            <div id="chart" class="mg-line-chart" style="width: 800px; height: 400px; margin: auto;"></div>
        </div>
        <div class="col ms-2" style="width: 200px; height: 400px; overflow-y: scroll; background: #2C3034;">
            <div class="py-2"><button class="btn btn-success btn-sm" id="csv" disabled><i
                        class="fa-solid fa-download"></i>
                    Baixar</button></div>
            <div id="output">

                <table class="table table-dark table-striped">
                    <thead>
                        <tr>
                            <th scope="col">#</th>
                            <th scope="col"><i class="fa-regular fa-clock"></i> Time</th>
                            <th scope="col">Valor</th>
                        </tr>
                    </thead>
                    <tbody id="rowTable">
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="p-3 col-3">
            <label for="graus" style="font-weight: 600;">Graus</label>
            <input type="text" id="graus" class="form-control">
        </div>
    </div>
    <script src="https://code.jquery.com/jquery-3.7.1.js"
        integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>

    <script src="https://cdn.jsdelivr.net/npm/d3/dist/d3.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/metrics-graphics/dist/metricsgraphics.min.js"></script>
    <script>
        // Inicializa os dados do gráfico
        let chartData = []; // [{ date: Date, value: number }]
        let minX = new Date(); // Define o início do intervalo
        let maxX = new Date(minX.getTime() + 60 * 1000);
        let isPaused = false; // Estado de pausa

        // Referência ao botão de pausa
        const pauseButton = document.getElementById("pause");

        // Alterna entre pausar e continuar
        pauseButton.addEventListener("click", () => {
            isPaused = !isPaused;
            pauseButton.textContent = isPaused ? "Continuar" : "Pausar";
        });

        // Função para renderizar o gráfico
        function renderChart(data) {
            if (!data || data.length === 0) {
                console.error("Nenhum dado disponível para o gráfico.");
                return; // Não tenta renderizar o gráfico se os dados estiverem vazios
            }
            MG.data_graphic({
                title: "Gráfico em Tempo Real",
                description: "Atualizado em tempo real via WebSocket",
                data: data,
                full_width: true,
                width: 600,
                height: 400,
                target: "#chart",
                x_accessor: "date",
                y_accessor: "value",
                min_x: minX, // Define o limite inferior do eixo X
                max_x: maxX, // Define o limite superior do eixo X
                min_y: -50,
                max_y: 50,
                show_tooltips: true,
                animate_on_load: true,
            });
        }

        // Inicializa o gráfico vazio
        renderChart(chartData);

        // WebSocket para receber dados
        const ws = new WebSocket("ws://localhost:3000");
        const output = document.getElementById("output");
        const send = document.getElementById("send");
        const grausInput = document.getElementById("graus");
        const refresh = document.getElementById("refresh");

        send.addEventListener("click", () => {
            const port = document.getElementById("port").value;
            ws.send(port);
            output.innerHTML += log("Sent", port);
        });

        refresh.addEventListener("click", () => {
            chartData = [];
            renderChart(chartData);
            const rowTable = document.getElementById("rowTable");
            rowTable.innerHTML = "";
        });

        // Função para converter a tabela HTML em CSV
        function tableToCSV() {
            // Selecionar toda a tabela, incluindo o cabeçalho
            const table = document.querySelector("table");
            const rows = table.querySelectorAll("tr");

            let csvContent = ""; // Conteúdo do CSV

            // Iterar sobre cada linha da tabela (incluindo o cabeçalho)
            rows.forEach(row => {
                const cells = row.querySelectorAll("th, td");
                const rowData = Array.from(cells)
                    .map(cell => cell.textContent.trim()) // Extrair o texto das células
                    .join(","); // Separar por vírgulas
                csvContent += rowData + "\n"; // Adicionar a linha ao CSV
            });

            return `data:text/csv;charset=utf-8,${csvContent}`;
        }

        // Função para baixar o arquivo CSV
        function downloadCSV() {
            const csvContent = tableToCSV(); // Obter o CSV
            const encodedUri = encodeURI(csvContent); // Codificar o conteúdo para download
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "dados_tabela.csv");
            document.body.appendChild(link); // Adicionar o link ao DOM
            link.click(); // Simular o clique para iniciar o download
            document.body.removeChild(link); // Remover o link do DOM
        }

        // Adicionar evento de clique ao botão de download
        document.getElementById("csv").addEventListener("click", downloadCSV);

        function log(index, valor, data) {
            return `<tr>
                        <th scope="row">${index}</th>
                        <td>${data}</td>
                        <td>${valor}</td>
                    </tr>`;
        }

        ws.onmessage = function (e) {
            // Ignorar mensagens se estiver pausado
            if (isPaused) return;

            const receivedData = JSON.parse(e.data);
            if (receivedData.status == "erro") {
                alert(receivedData.msg);
            } else {
                const rowTable = document.getElementById("rowTable");
                const index = rowTable.querySelectorAll("tr").length + 1;
                rowTable.insertAdjacentHTML(
                    "beforeend",
                    log(index, receivedData.value, receivedData.timestamp)
                );

                const timestamp = new Date(receivedData.timestamp);
                const value = parseFloat(receivedData.value);

                // Adiciona novos dados ao gráfico
                chartData.push({ "value": value, "date": timestamp });

                // Atualiza min_x e max_x para manter 60 segundos de intervalo
                minX = new Date(chartData[0].date.getTime() - 10 * 1000); // 10 segundos antes do primeiro ponto
                maxX = new Date(chartData[chartData.length - 1].date.getTime() + 10 * 1000); // 10 segundos depois do último ponto
                grausInput.value = value;
                renderChart(chartData);
            }
        };

        ws.onclose = function (e) {
            output.innerHTML += log("Disconnected", e.code);
        };

        ws.onerror = function (e) {
            output.innerHTML += log("Error", e.data);
        };
    </script>
</body>

</html>